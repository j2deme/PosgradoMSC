{% extends "base.html" %}

{% block page_title %}{{ task.name}}{% endblock %}
{% block breadcrumb %}
<ul class="breadcrumb">
{% if user.role == 1%}
  <li>
    <a href="{{ urlFor('home') }}">Inicio</a> <span class="divider">/</span>
  </li>
{% endif %}
  <li>
  	<a href="{{ urlFor('district', {'id': district.id}) }}">Distrito {{ district.id }}</a> <span class="divider">/</span>
  </li>
  <li>
  	<a href="{{ urlFor('activity', {'district': district.id, 'activity': activity.id, 'task': task.id}) }}">{{ activity.name }}</a> <span class="divider">/</span>
  </li>
  <li class="active">{{ task.name }}</li>
</ul>
{% endblock %}

{% block content %}
<div class="row">
	<div class="offset2 span8 content">
	{% if user.role <= 2%}
		<a href="{{ urlFor('subtask', {'district': district.id, 'activity': activity.id, 'task': task.id}) }}" class="btn"><i class="icon-plus"></i> Nueva Subtarea</a>
		<br /><br />
  	{% endif %}
		<h3>Subtareas</h3>
		<table class="table table-striped table-bordered table-condensed">
			<thead>
				<th>#</th>
				<th>Nombre</th>
				<th>Inicio</th>
				<th>Fin</th>
				<th>Estatus</th>
				<th>Opciones</th>
			</thead>
			<tbody>
			{% for subtask in subtasks %}
				{% if subtask.deleted == 1%}
				{% else %}
				<tr>
					<td>{{ loop.index }}</td>
					<td>
						<a href="#" rel="popover" data-content="{{ subtask.description }}" data-original-title="Descripción">{{ subtask.name }}</a>
					</td>
					<td>{{ subtask.start_date|date("d/m/Y") }}</td>
					<td>{{ subtask.end_date|date("d/m/Y") }}</td>
					<td class="{{ subis[subtask.id].status }}"><strong>{{ subis[subtask.id].visual }}</strong></td>
					<td>
						<a href="{{ urlFor('subtask-edit', {'district': district.id, 'activity': activity.id, 'task': task.id, 'sb': subtask.id}) }}"><i class="icon-pencil"></i> Editar</a>
						{% if user.role <= 2%}
						<a data-toggle="modal" href="#delete-subtask{{ subtask.id }}"><i class="icon-trash"></i> Eliminar</a>
  						{% endif %}  
						<a data-toggle="modal" href="#comments-of-subtask{{ subtask.id }}"><i class="icon-book"></i> Historial de Cambios</a>
					</td>
				</tr>
				<div class="modal fade" id="delete-subtask{{ subtask.id }}" name="delete-subtask{{ subtask.id }}">
					<div class="modal-header">
						<button class="close" data-dismiss="modal">&times;</button>
				    	<h3>Eliminar Subtarea</h3>
					</div>
					<div class="modal-body">
						<p>¿Está seguro de eliminar la subtarea <strong>{{ subtask.name }}</strong> y sus comentarios relacionados?</p>
						<p>Esta acción no es reversible y se verá reflejada en el estatus de la tarea <strong>{{ task.name }}.</strong></p>
					</div>
					<div class="modal-footer">
						<form method="post" action="{{ urlFor('subtask-delete-post', {'sb': subtask.id}) }}">
							<button type="submit" id="delete-subtask{{ subtask.id }}" name="delete-subtask{{ subtask.id }}" class="btn btn-danger">Eliminar</button>
						</form>
				    	<a href="#" class="btn" data-dismiss="modal">Cancelar</a>
				  	</div>
				</div>
				<div class="modal fade" id="comments-of-subtask{{ subtask.id }}" name="comments-of-subtask{{ subtask.id }}">
					<div class="modal-header">
				    	<button class="close" data-dismiss="modal">&times;</button>
				    	<h3>Historial de cambios</h3>
				  	</div>
				  	<div class="modal-body">
				  		<h2>{{ subtask.name }}</h2>
				  		<dl>
				  		{% for comment in comments[subtask.id] %}
        					<dt>{{ comment.created|date("d/m/Y \\a \\l\\a\\s H:i:s") }} - {{ cmtis[comment.id].visual }}</dt>
        					<dd>{{ comment.body }}</dd>
				    	{% endfor %}
				    	</dl>
				  	</div>
				  	<div class="modal-footer">
				    	<a href="#" class="btn" data-dismiss="modal">Cerrar</a>
				  	</div>
				</div>
				{% endif %}
			{% endfor %}
			</tbody>
		</table>		
	</div>	
</div>
{% endblock %}
